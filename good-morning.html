<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Good Morning</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/auth-guard.js"></script>
  <style>
    /* New gradient background system (match index.html) */
    :root{
      --bg-start: #fff4e6;
      --bg-end:   #fefce8;
      --brand:    #f5ba07;
    }
    body {
      background:
        radial-gradient(1200px 800px at 15% -10%, var(--bg-start) 0%, transparent 60%),
        radial-gradient(1200px 800px at 85% 10%,  var(--bg-end) 0%, transparent 60%),
        linear-gradient(180deg, #ffffff 10%, #fafbff 100%);
      position: relative;
      min-height: 100vh;
    }
    body::before{
      content:""; position: fixed; inset: 0; pointer-events: none;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/><feComponentTransfer><feFuncA type='table' tableValues='0 0 0 0 .015 .03 0 0 0'/></feComponentTransfer></filter><rect width='120' height='120' filter='url(%23n)'/></svg>");
      background-size: 300px 300px; opacity: .35; mix-blend-mode: multiply;
    }
    .card{backdrop-filter: blur(10px);}  
  </style>
  <script>
    async function api(path, opts){ const r = await fetch(path, Object.assign({ credentials:'same-origin', headers:{'Content-Type':'application/json'}}, opts||{})); if(!r.ok){throw new Error(await r.text());} return r.json(); }
    async function loadSettings(){ try{ const j = await api('/api/gm-save-settings'); const s = j.settings || {}; email.value = s.email||''; wants_email.checked = !!s.wants_email; wants_push.checked = !!s.wants_push; category.value = s.category||'loving'; delivery_time.value = s.delivery_time||'08:00'; tz.value = s.tz||'America/Chicago'; }catch(e){console.error(e);} }
    async function saveSettings(e){ e.preventDefault(); const body={ email: email.value, wants_email: wants_email.checked, wants_push: wants_push.checked, category: category.value, delivery_time: delivery_time.value, tz: tz.value, is_active:true }; await api('/api/gm-save-settings',{ method:'POST', body: JSON.stringify(body)}); alert('Saved'); }
    async function loadHistory(){ const j = await api('/api/gm-list-history'); const list = document.getElementById('history'); list.innerHTML=''; (j.items||[]).forEach(h=>{ const li=document.createElement('li'); li.className='py-1 text-sm'; li.textContent = `${new Date(h.created_at).toLocaleString()} – ${h.channel} – ${h.category} – ${h.status}: ${h.content}`; list.appendChild(li); }); }
    async function sendTest(){ const j = await api('/api/gm-cron'); alert('Test triggered: '+ (j.message||'ok')); await loadHistory(); }
    async function enablePush(){ if(!('serviceWorker' in navigator) || !('PushManager' in window)) { alert('Push not supported'); return; } const reg = await navigator.serviceWorker.register('/gm-sw.js'); const sub = await reg.pushManager.subscribe({ userVisibleOnly:true, applicationServerKey: (window.VAPID_PUBLIC_KEY||'') }); await api('/api/gm-subscribe',{ method:'POST', body: JSON.stringify({ subscription: sub.toJSON() })}); alert('Push enabled'); }
    document.addEventListener('DOMContentLoaded', async () => { await loadSettings(); await loadHistory(); });
  </script>
</head>
<body class="text-slate-800">
  <header class="relative">
    <div aria-hidden="true" class="pointer-events-none absolute inset-x-0 -top-24 h-72 bg-gradient-to-r from-orange-200 via-amber-200 to-yellow-200 blur-3xl opacity-60"></div>
    <div class="relative mx-auto max-w-5xl px-6 pt-20 pb-10">
      <div class="backdrop-blur-md bg-white/50 rounded-2xl shadow-[0_10px_30px_rgba(0,0,0,.08)] ring-1 ring-white/60">
        <div class="px-8 py-10 text-center">
          <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-slate-900">Daily Good Morning</h1>
          <p class="mt-3 text-slate-600 max-w-2xl mx-auto">Customize how and when messages are delivered.</p>
          <div class="mt-6 flex justify-center gap-3">
            <a href="/timeline.html" class="inline-flex items-center rounded-xl px-5 py-2.5 text-white font-medium bg-[var(--brand)] hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--brand)] transition">View Timeline</a>
            <a href="/index.html" class="inline-flex items-center rounded-xl px-5 py-2.5 text-gray-700 font-medium bg-white/70 hover:bg-white/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300 transition border border-gray-200">Back to scrapbook</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-6 -mt-4">
    <section class="bg-white/70 card rounded-2xl p-5 ring-1 ring-black/5 shadow mb-6">
      <h2 class="text-xl font-semibold mb-3">Settings</h2>
      <form id="settings" class="grid gap-4 sm:grid-cols-2" onsubmit="saveSettings(event)">
        <label class="block">Email
          <input id="email" type="email" placeholder="her@email.com" class="mt-1 w-full rounded border px-3 py-2" />
        </label>
        <label class="flex items-center gap-2"><input id="wants_email" type="checkbox" class="rounded"/> Email</label>
        <label class="flex items-center gap-2"><input id="wants_push" type="checkbox" class="rounded"/> Website push</label>
        <label class="block">Message type
          <select id="category" class="mt-1 w-full rounded border px-3 py-2">
            <option value="funny">Funny</option>
            <option value="loving">Loving</option>
            <option value="playful">Playful</option>
          </select>
        </label>
        <label class="block">Delivery time
          <input id="delivery_time" type="time" class="mt-1 w-full rounded border px-3 py-2" />
        </label>
        <label class="block">Time zone
          <input id="tz" type="text" placeholder="America/Chicago" class="mt-1 w-full rounded border px-3 py-2" />
        </label>
        <div class="sm:col-span-2 flex flex-wrap gap-3 mt-2">
          <button type="submit" class="px-5 py-2 rounded bg-[var(--brand)] text-white">Save</button>
          <button type="button" onclick="enablePush()" class="px-5 py-2 rounded bg-slate-700 text-white">Enable push</button>
          <button type="button" onclick="sendTest()" class="px-5 py-2 rounded bg-emerald-600 text-white">Send test now</button>
        </div>
      </form>
    </section>

    <section class="bg-white/70 card rounded-2xl p-5 ring-1 ring-black/5 shadow mb-10">
      <h2 class="text-xl font-semibold mb-3">Send History</h2>
      <ul id="history" class="pl-4"></ul>
    </section>
  </main>
</body>
</html>
